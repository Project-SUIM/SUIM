package coffee.axle.suim.feature.exploit;

import coffee.axle.suim.events.ReceivePacketEvent;
import coffee.axle.suim.events.SendPacketEvent;
import coffee.axle.suim.feature.Feature;
import coffee.axle.suim.feature.GuiCategory;
import coffee.axle.suim.util.MyauLogger;
import coffee.axle.suim.util.PacketUtils;
import coffee.axle.suim.util.Utils;

import net.minecraft.client.Minecraft;
import net.minecraft.entity.Entity;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.entity.item.EntityArmorStand;
import net.minecraft.entity.passive.EntityVillager;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C02PacketUseEntity;
import net.minecraftforge.common.MinecraftForge;
import net.minecraftforge.fml.common.eventhandler.EventPriority;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import net.minecraftforge.fml.common.gameevent.TickEvent;

import java.util.ArrayList;
import java.util.List;

/**
 * ShopBlink — Bedwars shopkeeper exploit.
 * <p>
 * On right-click of a shopkeeper NPC, chokes all incoming packets,
 * rotates 180 degrees, sprint-jumps away, then unchokes.
 * The shop GUI opens after the blink since the S2DPacketOpenWindow is
 * buffered and flushed at the end, while the player has already moved away.
 * <p>
 * Detects both EntityVillager (classic shops) and EntityOtherPlayerMP
 * (custom-skin shops) by checking for armor stand holograms with
 * known shop labels ("ITEM SHOP", "UPGRADES", "RIGHT CLICK", etc.).
 */
public class ShopBlink extends Feature {

    private static final Minecraft mc = Minecraft.getMinecraft();

    private static final String[] DEBUG_MODES = { "NONE", "ROTATIONS" };
    private static final int DEBUG_NONE = 0;

    private Object moduleInstance;
    private Object blinkTicksProperty;
    private Object debugProperty;
    private Object blinkFirstTick;
    private Object forwardSpeedProperty;

    /** Whether a blink sequence is currently active. */
    private boolean active = false;

    /** Tick counter during the blink sequence. */
    private int tickCounter = 0;

    /** Buffered incoming packets during the blink. */
    private final List<Packet<?>> bufferedPackets = new ArrayList<>();

    /** Player yaw before the blink (restored after flush). */
    private float originalYaw;

    /** Player pitch before the blink (restored after flush). */
    private float originalPitch;

    @Override
    public String getName() {
        return "ShopBlink";
    }

    @Override
    public GuiCategory getGuiCategory() {
        return GuiCategory.EXPLOIT;
    }

    @Override
    public boolean initialize() {
        try {
            moduleInstance = createModule();
            creator.injectModule(moduleInstance, ShopBlink.class);

            blinkTicksProperty = creator.createIntegerProperty("ticks", 5, 2, 50);
            debugProperty = creator.createEnumProperty("debug", DEBUG_NONE, DEBUG_MODES);
            blinkFirstTick = creator.createBooleanProperty("move-first-tick", true);
            forwardSpeedProperty = creator.createFloatProperty("forward-speed", 1.0f, 0.1f, 1.5f);
            creator.registerProperties(moduleInstance, blinkTicksProperty, debugProperty, blinkFirstTick,
                    forwardSpeedProperty);

            manager.reloadModuleCommand();
            MinecraftForge.EVENT_BUS.register(this);

            manager.registerModuleCallbacks(
                    moduleInstance,
                    () -> {
                    },
                    () -> {
                        if (active) {
                            flush();
                        }
                    });

            MyauLogger.info("ShopBlink initialized");
            return true;
        } catch (Exception e) {
            MyauLogger.error("ShopBlink:init", e);
            return false;
        }
    }

    // ── Trigger: detect shop NPC right-click ──────────────────────────────

    @SubscribeEvent(priority = EventPriority.HIGHEST)
    public void onSendPacket(SendPacketEvent e) {
        if (!manager.isModuleEnabled(moduleInstance))
            return;
        if (!Utils.nullCheck())
            return;
        if (active)
            return;

        Packet<?> p = e.getPacket();
        if (!(p instanceof C02PacketUseEntity))
            return;

        C02PacketUseEntity useEntity = (C02PacketUseEntity) p;

        // Only trigger on INTERACT (right-click), not ATTACK
        if (useEntity.getAction() != C02PacketUseEntity.Action.INTERACT)
            return;

        Entity target = useEntity.getEntityFromWorld(mc.theWorld);
        if (!isShopNPC(target))
            return;

        // Shop NPC right-click detected — begin blink sequence
        active = true;
        tickCounter = 0;
        originalYaw = mc.thePlayer.rotationYaw;
        originalPitch = mc.thePlayer.rotationPitch;

        debugMsg("triggered | yaw=" + originalYaw + " pitch=" + originalPitch);
        // The C02 packet goes through — server processes the shop interaction
    }

    // ── Choke: buffer all incoming packets during blink ───────────────────

    @SubscribeEvent(priority = EventPriority.HIGHEST)
    public void onReceivePacket(ReceivePacketEvent e) {
        if (!active)
            return;

        synchronized (bufferedPackets) {
            bufferedPackets.add(e.getPacket());
        }
        e.setCanceled(true);
    }

    @SubscribeEvent
    public void onTick(TickEvent.ClientTickEvent e) {
        if (e.phase != TickEvent.Phase.START)
            return;
        if (!active)
            return;
        if (!Utils.nullCheck())
            return;

        tickCounter++;
        int blinkDuration = getBlinkTicks();
        if (tickCounter == 1) {
            mc.thePlayer.rotationYaw = originalYaw + 180.0f;
            mc.thePlayer.rotationPitch = 0.0f;
            mc.thePlayer.setSprinting(true);
            mc.thePlayer.jump();
            if (getMoveOnFirstTick()) {
                mc.thePlayer.movementInput.moveForward = getForwardSpeed();
            }
            debugMsg("rotated to yaw=" + mc.thePlayer.rotationYaw);
        } else if (tickCounter <= blinkDuration) {
            mc.thePlayer.setSprinting(true);
            mc.thePlayer.movementInput.moveForward = getForwardSpeed();

        }
        if (tickCounter >= blinkDuration) {
            flush();
        }
    }

    // ── Helpers ────────────────────────────────────────────────────────────

    private int getBlinkTicks() {
        try {
            return properties.getInt(blinkTicksProperty, 5);
        } catch (Exception e) {
            return 5;
        }
    }

    private boolean getMoveOnFirstTick() {
        return properties.getBoolean(blinkFirstTick, true);
    }

    private float getForwardSpeed() {
        try {
            return properties.getFloat(forwardSpeedProperty, 1.0f);
        } catch (Exception e) {
            return 1.0f;
        }
    }

    private int getDebugMode() {
        try {
            return properties.getInt(debugProperty, DEBUG_NONE);
        } catch (Exception e) {
            return DEBUG_NONE;
        }
    }

    // ── Shop NPC Detection ──────────────────────────────────────────────

    /**
     * Checks whether an entity is a Bedwars shop NPC.
     * Covers both classic villager shops and custom-skin player-type NPCs.
     * Player-type NPCs are identified by armor stand holograms above them
     * containing known shop labels.
     */
    private boolean isShopNPC(Entity entity) {
        if (entity == null || entity == mc.thePlayer)
            return false;

        // Classic shop: vanilla villager
        if (entity instanceof EntityVillager)
            return true;

        // Custom-skin shop: player entity with a shop hologram above it
        if (entity instanceof EntityLivingBase) {
            return hasShopHologram((EntityLivingBase) entity);
        }

        return false;
    }

    /**
     * Checks for an armor stand within the entity's bounding box whose
     * display name contains a known Bedwars shop label.
     *
     * @see myau.util.TeamUtil#isShop (OpenMyau reference)
     */
    private boolean hasShopHologram(EntityLivingBase entity) {
        EntityLivingBase armorStand = mc.theWorld.findNearestEntityWithinAABB(
                EntityArmorStand.class, entity.getEntityBoundingBox(), entity);
        if (armorStand == null)
            return false;

        String name = armorStand.getName();
        return name.contains("RIGHT CLICK")
                || name.contains("ITEM SHOP")
                || name.contains("UPGRADES")
                || name.contains("BANKER")
                || name.contains("STREAK POWERS");
    }

    // ── Debug ──────────────────────────────────────────────────────────────

    private void debugMsg(String msg) {
        if (getDebugMode() <= DEBUG_NONE)
            return;
        manager.sendMessage("&8[&eShopBlink&8] &7" + msg);
    }

    @SuppressWarnings({ "unchecked", "rawtypes" })
    private void flush() {
        synchronized (bufferedPackets) {
            for (Packet<?> p : bufferedPackets) {
                Packet raw = (Packet) p;
                PacketUtils.skipReceiveEvent.add(raw);
                try {
                    raw.processPacket(mc.getNetHandler());
                } catch (Exception e) {
                    MyauLogger.error("ShopBlink:flush", e);
                }
            }
            bufferedPackets.clear();
        }

        active = false;
        tickCounter = 0;
    }
}
